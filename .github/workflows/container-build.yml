name: pulumi sdk containers build
on:
  repository_dispatch:
    types:
      - docker-build

jobs:
  base:
    name: Build Pulumi SDK Base Image
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pulumi_version: ["latest", "${{ github.event.client_payload.ref }}"]
    steps:
      - uses: actions/checkout@master
      - name: Build base image
        uses: jaxxstorm/action-docker-build@release/v3.beta
        with:
          repository: pulumi/pulumi-base
          buildkit: true
          username: ${{ github.actor }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
          dockerfile: base/Dockerfile
          additional-tags: ${{ matrix.pulumi_version }}
          build-args: PULUMI_VERSION=${{ matrix.pulumi_version }}
  sdk:
    name: Build Pulumi SDK Images
    runs-on: ubuntu-latest
    needs: base
    strategy:
      max-parallel: 6
      fail-fast: false
      matrix:
        sdk: [ "nodejs", "python", "dotnet", "go" ]
        pulumi_version: ["latest", "${{ github.event.client_payload.ref }}"]
    steps:
      - uses: actions/checkout@master
      - name: Build image
        uses: jaxxstorm/action-docker-build@release/v3.beta
        with:
          repository: pulumi/pulumi-${{matrix.sdk}}
          buildkit: true
          username: ${{ github.actor }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
          dockerfile: ${{ matrix.sdk }}/Dockerfile
          additional-tags: ${{ matrix.pulumi_version }}
          build-args: PULUMI_VERSION=${{ matrix.pulumi_version }}
