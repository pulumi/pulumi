on:
  push:
    branches: ["master"]

env:
  PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

jobs:
  publish-sdks:
    name: Publish SDKs
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [14.x]
        language: ["nodejs"]
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2
      - name: Set up Node ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
          cache: yarn
          cache-dependency-path: sdk/nodejs/package.json
          registry-url: https://registry.npmjs.org
          always-auth: true
      - name: Install pulumictl
        uses: jaxxstorm/action-install-gh-release@v1.7.1
        with:
          repo: pulumi/pulumictl
          tag: v0.0.32
          cache: enable
      - name: Install pipenv
        uses: dschep/install-pipenv-action@v1
      - name: Fetch Tags
        run: git fetch --quiet --prune --unshallow --tags
      - name: Update path
        run: echo "${{ runner.temp }}/opt/pulumi/bin" >> $GITHUB_PATH
      - name: Ensure
        run: make ensure
      - run: git status
      - name: Configure NPM authentication
        run: |
          yarn config set npmAlwaysAuth true
          yarn config set npmAuthToken ${{ secrets.NPM_TOKEN }}
      - name: Publish Packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          make -C sdk/${{ matrix.language}} publish

