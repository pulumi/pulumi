#!/usr/bin/env bash

# This script regenerates all Protobuf/gRPC client files.
#
# This script relies on mise to manage tool versions and dependencies.
# Dependencies are automatically installed by the Makefile before this script runs.

set -o errexit
set -o pipefail

# Ensure we're in the proto directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Get protoc version
PROTOC_VERSION=$(protoc --version | head -n1 | tr -d '\n\r')
echo "* Generating Protobuf/gRPC SDK files:"
echo -e "\tVERSION: $PROTOC_VERSION"
echo -e "Generated by version $PROTOC_VERSION of protoc" > ./grpc_version.txt

# Get paths to local tools
NODE_MODULES_BIN="$(pwd)/node_modules/.bin"
GRPC_TOOLS_NODE_PROTOC_PLUGIN="$NODE_MODULES_BIN/grpc_tools_node_protoc_plugin"
PROTOC_GEN_TS="$NODE_MODULES_BIN/protoc-gen-ts"
PROTOC_GEN_JS="$NODE_MODULES_BIN/protoc-gen-js"
# Add node_modules/.bin to PATH so protoc can find plugins
export PATH="$NODE_MODULES_BIN:$PATH"

# `status.proto` are in our source tree so that we can implement initialization failure in the
# dynamic client (written in JS) using the protobuf notion of "details" -- arbitrary protobuf
# messages packaged up inside of an error. Hence, JavaScript and Python include it but Go does not.

# Generate Go code
echo "* Generating Go code..."
GO_PULUMIRPC="$(pwd)/../sdk/proto/go"
PROTO_FILES=$(find . -name "*.proto" -not -name "status.proto" -not -path "./node_modules/*")
TEMP_DIR_GO=$(mktemp -d)
trap "rm -rf $TEMP_DIR_GO" EXIT

echo -e "\tGO temp dir: $TEMP_DIR_GO"
protoc \
    --go_out="$TEMP_DIR_GO" --go_opt=paths=source_relative \
    --go-grpc_out="$TEMP_DIR_GO" --go-grpc_opt=paths=source_relative \
    $PROTO_FILES

rm -rf "$GO_PULUMIRPC"/*
cp -r "$TEMP_DIR_GO"/pulumi/* "$GO_PULUMIRPC"

# Protoc for JavaScript has a bug where it emits Google Closure Compiler directives in the module prologue that mutate
# the global object, which causes side-by-side bugs in pulumi/pulumi (pulumi/pulumi#2401). The protoc compiler
# absolutely should not be emitting commonjs modules that mutate global, but alas, it does, and we have to sed the
# output to not do that.
#
# We're replacing the literal code string
#   var global = Function('return this')();
# with
#   var proto = { pulumirpc: ... }, global = proto;
#
# This sets up the remainder of the protobuf file so that it works fine, but doesn't mess with global. Note
# that we have to skip this transformation for the google/protobuf/status_pb.js file because it _does_ depend
# on that global state (https://github.com/pulumi/pulumi/pull/2403#issuecomment-458673703).
echo "* Generating JavaScript/TypeScript code..."
JS_PULUMIRPC="$(pwd)/../sdk/nodejs/proto"
JS_PROTOFLAGS="import_style=commonjs,binary"
PROTO_FILES=$(find . -name "*.proto" -not -path "./node_modules/*")
TEMP_DIR_JS=$(mktemp -d)
trap "rm -rf $TEMP_DIR_JS" EXIT

echo -e "\tJavaScript: $JS_PULUMIRPC [$JS_PROTOFLAGS]"
echo -e "\tJavaScript temp dir: $TEMP_DIR_JS"
mkdir -p "$TEMP_DIR_JS"

protoc \
    --js_out="$JS_PROTOFLAGS:$TEMP_DIR_JS" \
    --ts_out="grpc_js:$TEMP_DIR_JS" \
    --grpc_out="grpc_js,minimum_node_version=6:$TEMP_DIR_JS" \
    --plugin="protoc-gen-js=$PROTOC_GEN_JS" \
    --plugin="protoc-gen-grpc=$GRPC_TOOLS_NODE_PROTOC_PLUGIN" \
    --plugin="protoc-gen-ts=$PROTOC_GEN_TS" \
    $PROTO_FILES

# Fix TypeScript import paths (using portable sed syntax)
if [[ "$OSTYPE" == "darwin"* ]]; then
    SED_INPLACE="sed -i.bak"
else
    SED_INPLACE="sed -i"
fi

find "$TEMP_DIR_JS/pulumi" -type f -name "*.ts" -exec $SED_INPLACE "s|../pulumi/|./|" {} \;
find "$TEMP_DIR_JS/pulumi" -type f -name "*.ts" -exec $SED_INPLACE "s|/./|/|" {} \;
find "$TEMP_DIR_JS/pulumi" -type f -name "*.ts.bak" -delete 2>/dev/null || true

# Fix JavaScript global mutation bug and import paths
find "$TEMP_DIR_JS/pulumi" -type f -name "*.js" -exec $SED_INPLACE "s|^var global = .*;|var proto = { pulumirpc: { codegen: { }, testing: { } } }, global = proto;|" {} \;
find "$TEMP_DIR_JS/pulumi" -type f -name "*.js" -exec $SED_INPLACE "s|require('../pulumi/|require('./|" {} \;
find "$TEMP_DIR_JS/pulumi" -type f -name "*.js" -exec $SED_INPLACE "s|require('../../pulumi/|require('../|" {} \;
find "$TEMP_DIR_JS/pulumi" -type f -name "*.js.bak" -delete 2>/dev/null || true

rm -rf "$JS_PULUMIRPC"/*
cp "$TEMP_DIR_JS"/google/protobuf/*.js "$JS_PULUMIRPC" 2>/dev/null || true
cp "$TEMP_DIR_JS"/google/protobuf/*.ts "$JS_PULUMIRPC" 2>/dev/null || true
cp -r "$TEMP_DIR_JS"/pulumi/* "$JS_PULUMIRPC"

# Protoc for Python has a bug where, if your proto files are all in the same directory relative
# to one another, imports of said proto files will produce imports that don't work using Python 3.
#
# Since our proto files are all in the same directory, this little bit of sed rewrites the broken
# imports that protoc produces, of the form
#     import foo_pb2 as bar
# to the form
#     from . import foo_pb2 as bar
# This form is semantically equivalent and is accepted by both Python 2 and Python 3.
#
# mypy_protoc doesn't yet support aio which we use (https://github.com/nipunn1313/mypy-protobuf/issues/216) so
# we 'sed' to do some replacements to support that, adding an import for grpc.aio and typing and changing
# grpc.Server to Union[grpc.Server, grpc.aio.Server].
#
# mypy_protoc also marks all server methods as abstract, they aren't really abstract because they have default
# implementations that simply return a grpc error that it's not implemented, we make use of those default
# methods so don't want type checking telling us to fill them all in.
echo "* Generating Python code..."
PY_PULUMIRPC="$(pwd)/../sdk/python/lib/pulumi/runtime/proto/"
PROTO_FILES=$(find . -name "*.proto" -not -path "./node_modules/*")
TEMP_DIR_PY=$(mktemp -d)
trap "rm -rf $TEMP_DIR_PY" EXIT

echo -e "\tPython: $PY_PULUMIRPC"
echo -e "\tPython temp dir: $TEMP_DIR_PY"
mkdir -p "$TEMP_DIR_PY"

python3 -m grpc_tools.protoc \
    -I./ \
    --python_out="$TEMP_DIR_PY" \
    --mypy_out="$TEMP_DIR_PY" \
    --grpc_python_out="$TEMP_DIR_PY" \
    --mypy_grpc_out="$TEMP_DIR_PY" \
    $PROTO_FILES

for pyfile in "$TEMP_DIR_PY"/pulumi/*.py; do
    $SED_INPLACE "s/^from pulumi import \([^ ]*\)_pb2 as \([^ ]*\)$/from . import \1_pb2 as \2/" "$pyfile"
    $SED_INPLACE "s/^from pulumi.codegen import \([^ ]*\)_pb2 as \([^ ]*\)$/from .codegen import \1_pb2 as \2/" "$pyfile"
done

# Fix mypy stub files (only add imports if they don't already exist, matching original Docker script)
for pyifile in "$TEMP_DIR_PY"/pulumi/*.pyi; do
    $SED_INPLACE "s/^import grpc$/import grpc\nimport grpc.aio\nimport typing/" "$pyifile"
    $SED_INPLACE "s/: grpc\.Server/: typing.Union[grpc.Server, grpc.aio.Server]/" "$pyifile"
    $SED_INPLACE "s/@abc.abstractmethod//" "$pyifile"
done

find "$TEMP_DIR_PY/pulumi" -type f -name "*.py*.bak" -delete 2>/dev/null || true

rm -rf "$PY_PULUMIRPC"/*
cp -r "$TEMP_DIR_PY"/pulumi/* "$PY_PULUMIRPC"
cp -r "$TEMP_DIR_PY"/google/protobuf/* "$PY_PULUMIRPC"

# python protoc doesn't generate __init__.py files, and autogenerating them is a bit tricky, so we just
# restore them from git after each generate.
cd ..
git diff --name-only --diff-filter D | grep __init__.py | xargs git restore 2>/dev/null || true

echo "* Done."
